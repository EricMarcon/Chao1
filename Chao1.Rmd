---
title: "L'estimateur Chao1"
author: "Eric Marcon"
date: "`r format(Sys.time(), '%d %B %Y')`"
preamble: >
  \usepackage{textcomp}
  \DeclareUnicodeCharacter{B0}{\textdegree}
bibliography: Chao1.bib
output:
  beamer_presentation:
    df_print: kable
    fig_caption: no
    includes:
      in_header: EcoFoGBeamer.tex
    keep_tex: no
    slide_level: 2
  ioslides_presentation:
    logo: images/EcoFoG2020.png
    widescreen: true
  slidy_presentation: default
---

```{r setup, include=FALSE}
### knitr and R options (packages, ...)
# echo=FALSE not to display R chunk in slides. Set to TRUE if necessary.
knitr::opts_chunk$set(echo = FALSE, cache=TRUE)
# tidy R chunks.
knitr::opts_chunk$set(tidy=TRUE, tidy.opts=list(blank=FALSE, width.cutoff=50))
# R console width
options(width=50)
# Plot margins
par(mar = c(2, 2, 2, 2))
# Installation des packages si nécessaire et chargement
Library <- function(Packages) {
  InstallAndLoad <- function(Package) {
    if (!Package %in% installed.packages()[, 1]) {install.packages(Package, repos="https://cran.rstudio.com/")}
    require(Package, character.only = TRUE)
  }
  invisible(sapply(Packages, InstallAndLoad))
}
# Ajouter les packages nécessaires ici
Library(c("kableExtra", "tidyverse", "entropart"))
# Set ggplotting to bw plot default, but with transparent background elements.  
theme_set(theme_bw(base_size=12))
theme_update(panel.background = element_rect(fill = "transparent", colour = NA),
             plot.background = element_rect(fill = "transparent", colour = NA))
knitr::opts_chunk$set(dev.args=list(bg="transparent"))
# Tibbles: 5 lines, fit to slide width
options(tibble.print_min = 5, tibble.width = 50)
# Répétabilité
set.seed(97310)
```


# Introduction

<!-- Code HTML complémentaire après le titre de première partie pour éviter une diapo blache --> 
<!-- Commande de saut de colonne HTML --> 
<style>
  .forceBreak { -webkit-column-break-after: always; break-after: column; }
</style>


## Problématique

Estimer la richesse (le nombre d'espèces) d'une communauté en forêt tropicale par exemple est difficile.

Beaucoup d'espèces sont rares donc un échantillonnage aléatoire (inventaire) de taille raisonnable ne permet pas de les observer.

Des estimateurs de la richesse ont été développés pour estimer la richesse réelle à partir d'un inventaire incomplet.


## Illustration {.columns-2} 

\begincols
  \begincol{.3\textwidth}

Inventaire d'une parcelle de Paracou, Sinamary, Guyane (https://paracou.cirad.fr)

```{r}
library("entropart")
# Données
load("data/Paracou6.rda")
# Comptage des arbres par espèces
Paracou6_inv <- as.AbdVector(tapply(Paracou6$marks$PointType, Paracou6$marks$PointType, FUN=length))
```

Nombre d'espèces observées : `r length(Paracou6_inv)`.

Espèce la plus abondante (wapa : $Eperua falcata$) : `r max(Paracou6_inv)` individus.

  <p class="forceBreak"></p>
  \endcol
  \begincol{.7\textwidth}

```{r, fig.asp=1, out.width='100%'}
# Carte
plot(Paracou6, asp=1, xlab="", ylab="")
```

  \endcol
\endcols


## Illustration

La parcelle est un échantillon de la communauté forestière locale.

```{r}
# Courbe rang-abondance
autoplot(Paracou6_inv)
```

Question : combien y a-t-il d'espèces d'arbres dans cette communauté ?


## Estimateur Chao1

Développé par Anne Chao [@Chao2004].

Premier estimateur utilisé largement par les écologues, bon support mathématique.

Intuition : 

- les espèces observées une fois auraient pu ne pas l'être.

- lien (à établir) entre les espèces observées un petit nombre de fois et les espèces manquées.


# Construction de l'estimateur

## Notations

Un inventaire de $n$ individus tirés indépendamment et aléatoirement est réalisé dans une communauté.

Les individus appartiennent à l'espèce $s$ avec la probabilité $p_s$, $\sum_1^S{p_s}=1$.

L'inventaire manque quelques espèces parmi les moins fréquentes : seules $s_{obs}$ espèces sont observées.

${s}_{n}^{\nu}$ est le nombre d'espèces observées $\nu$ fois dans un échantillon de taille $n$. C'est une réalisation de la variable aléatoire ${S}_{n}^{\nu}$.


## Observer une espèce

La probabilité qu'un individu inventorié ne soit pas de l'espèce $s$ est 

$$1-p_s$$

La probabilité de ne pas inclure l'espèce $s$ dans l'inventaire est 

$$(1-p_s)^n$$

La probabilité d'inclure l'espèce est donc

$$ 1-(1-p_s)^n$$

## Observer une espèce $\nu$ fois

La probabilité d'observer l'espèce $\nu$ fois avant de ne plus l'observer dans le reste de l'inventaire est

$$p_s^\nu(1-p_s)^{n-\nu}$$

La probabilité d'observer l'espèce $\nu$ fois dans l'inventaire est obtenue en prenant en compte toutes l'ordre des observations (combinaisons) : 

$$\binom{n}{\nu}p_s^\nu(1-p_s)^{n-\nu}$$

L'espérance du nombre d'espèces observées $\nu$ fois est obtenue en sommant cette probabilité sur toutes les espèces

$${\mathbb E}({S}_{n}^{\nu}) = \binom{n}{\nu} \sum_s{p_s^\nu \left( 1-p_s \right)^{n-\nu}}$$

## Représentation vectorielle

Soit le vecteur $\mathbf{v_{\nu}}$ dans ${\mathbb R}^S$ dont les coordonnées sont

$$p_s^\nu (1-p_s)^{(n/2)-\nu}$$

Le carré de la norme du vecteur $\mathbf{v_0}$ est 

$$\sum_s{(1-p_s)^n},$$
c'est-à-dire ${\mathbb E}({S}_{n}^{0})$, l'espérance du nombre d'espèces non observées.

(Attention : on ne connaît pas les $p_s$ !).


## Représentation vectorielle

Le carré de la norme du vecteur $\mathbf{v_1}$ est 

$$\sum_s{p_s^2(1-p_s)^{n-2}} = \frac{2}{n(n-1)}{\mathbb E}({S}_{n}^{2})$$


Enfin, le produit scalaire $\langle \mathbf{v_0}, \mathbf{v_1} \rangle$ vaut

$$\sum_s{p_s(1-p_s)^{n-1}}=\frac{1}{n}{\mathbb E}({S}_{n}^{1}).$$

## Représentation graphique

Soient deux espèces telles que $p_1=0,4$ et $p_2=0,6$, et $n=6$.

Le vecteur $\mathbf{v_0}$ a pour coordonnées $([1-0,4]^3;[1-0,6]^3)=(`r (1-0.4)^3`; `r (1-0.6)^3`)$.

Le vecteur $\mathbf{v_1}$ a pour coordonnées $(0,4 \times [1-0,4]^2;0,6 \times [1-0,6]^2)=(`r .4*(1-.4)^2`; `r .6*(1-.6)^2`)$.


## Représentation graphique

```{r vecteurs, out.width='65%'}
plot(x=c(0, (1-.4)^3, .4*(1-.4)^2), y=c(0, (1-.6)^3, .6*(1-.6)^2), type="n", xlab="", ylab="", asp=1)
arrows(0, 0, (1-0.4)^3, (1-0.6)^3)
arrows(0, 0, .4*(1-.4)^2, .6*(1-.6)^2, col="red")
```

Le vecteur $\mathbf{v_0}$ dont le carré de la norme est ${\mathbb E}({S}_{n}^{0})$ est en noir.

Le vecteur $\mathbf{v_1}$ dont le carré de la norme est $\frac{2}{n(n-1)}{\mathbb E}({S}_{n}^{2})$ est en rouge.


## Cauchy-Schwartz

Le produit scalaire est inférieur au produit des normes des vecteurs. La relation reste valide au carré:

$$\left[ \sum_s{(1-p_s)^n} \right] \left[ \sum_s{p_s^2(1-p_s)^{n-2}} \right] 
   \ge \left[ \sum_s{p_s(1-p_s)^{n-1}} \right]^2$$


En substituant les espérances et en réarrangeant:

$${\mathbb E}({S}_{n}^{0}) 
  \ge \frac{n-1}{n}\frac{\left[ {\mathbb E}({S}_{n}^{1}) \right]^2}{2 {\mathbb E}({S}_{n}^{2})}$$


## Estimateur

L'estimateur est obtenu en remplaçant les espérances par les valeurs observées:

$$ {\hat{S}}_\mathit{Chao1} 
   = {s}_{n}^{\ne 0} + \frac{\left(n-1 \right){\left({s}_{n}^{1}\right)}^2}{2n{{s}_{n}^{2}}}$$

## Usage

Il s'agit d'un estimateur minimum : l'espérance du nombre d'espèces est supérieure ou égale au nombre estimé.

L'estimation est bonne tant que l'inventaire n'est pas trop sous-échantilonné. 

Règle empirique [@Brose2003] : pas plus d'un tiers des espèces observées une seule fois. Au-delà: sous estimation importante.


# Application

## Simulation d'un inventaire

Commauté log-normale de 300 espèces, comparable à la forêt de Barro Colorado Island. Echantillon de 1800 arbres (3 ha de forêt).

```{r}
library("entropart")
# Taille de l'inventaire
n <- 1800
Inventaire <- rCommunity(1, size=n, S = 300, Distribution="lnorm",  sd=1)
autoplot(Inventaire, Distribution="lnorm")
```


## Estimation

Nombre d'espèces observées : `r (s_obs <- sum(Inventaire >0))`,

dont singletons : `r (s_1 <- sum(Inventaire==1))`,

et doubletons : `r (s_2 <- sum(Inventaire==2))`.


Estimateur Chao1 : `r round(s_obs + (n-1)*s_1^2/2/n/s_2)` espèces.



## Sous-échantillonnage

En limitant l'inventaire 600 arbres, environ 1 ha :

```{r}
# Taille de l'inventaire
n <- 600
Inventaire2 <- rCommunity(1, size=n, Distribution="lnorm",  sd=1)
```

Estimateur Chao1 : `r round(Richness(Inventaire2, Correction = "Chao1"))` espèces, très sous-estimé.

Nombre d'espèces observées : `r sum(Inventaire2>0)`, dont `r sum(Inventaire2 == 1)` singletons.

Il existe des estimateurs plus versatiles, comme le Jackknife [@Burnham1978] :

```{r}
Richness(Inventaire2)
```

## References {.smaller}

\tiny
